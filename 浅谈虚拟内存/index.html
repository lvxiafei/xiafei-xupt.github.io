<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>浅谈虚拟内存 | xiafei-xupt's blog</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">浅谈虚拟内存</h1><a id="logo" href="/.">xiafei-xupt's blog</a><p class="description">汝之意志所向,即吾剑之所指</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">浅谈虚拟内存</h1><div class="post-meta"><a href="/浅谈虚拟内存/#comments" class="comment-count"></a><p><span class="date">Nov 05, 2018</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>Hits</i></i></span></p></div><div class="post-content"><h2 id="什么是物理内存？"><a href="#什么是物理内存？" class="headerlink" title="什么是物理内存？"></a>什么是物理内存？</h2><p>Wiki上的解释为：<strong>物理内存</strong>是指由于安装<a href="https://zh.wikipedia.org/wiki/%E5%86%85%E5%AD%98" target="_blank" rel="noopener">内存条</a>而获得的临时储存空间。主要作用是在<a href="https://zh.wikipedia.org/wiki/%E8%AE%A1%E7%AE%97%E6%9C%BA" target="_blank" rel="noopener">计算机</a>运行时为<a href="https://zh.wikipedia.org/wiki/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F" target="_blank" rel="noopener">操作系统</a>和各种<a href="https://zh.wikipedia.org/wiki/%E7%A8%8B%E5%BA%8F" target="_blank" rel="noopener">程序</a>提供临时储存。常见的物理内存规格有256M、512M、1G、2G等，当物理内存不足时，可以用<a href="https://zh.wikipedia.org/wiki/%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98" target="_blank" rel="noopener">虚拟内存</a>代替。</p>
<p>也就是说，物理内存可抽象理解为内存条本身，类似于数组，从0开始编址，物理地址与内存一一相应</p>
<h2 id="那么什么又是虚拟内存呢？"><a href="#那么什么又是虚拟内存呢？" class="headerlink" title="那么什么又是虚拟内存呢？"></a><strong>那么什么又是虚拟内存呢？</strong></h2><p>现在的操作系统有物理内存和虚拟内存之分，然而在很久之前，是没有虚拟内存概念的，那时，程序寻址用的都是物理地址，众所周知，物理地址大小取决于CPU的地址总线条数。在8086CPU中，地址总线20位，说明物理内存大小为2^20=1M空间，在IA32架构中，寻址范围是2^32也就是4G大小的固定空间，假设一下，如果没有虚拟内存，则每次开启一个进程都给4G的物理内存，就会遇到各种各样的问题？例如：<br>1)进程地址空间不隔离，没有权限保护。<br>由于程序都是直接访问物理内存，所以一个进程可以修改其他进程的内存数据，甚至修改内核地址空间中的数据。<br>2)内存使用效率低<br>物理内存有限，当多个进程执行时，都要给4G内存，当内存空间不足时，要将其他程序暂时拷贝到硬盘，然后将新的程序装入内存运行。由于大量的数据装入装出，内存使用效率会十分低下。<br>3)程序运行的地址不确定<br>因为内存地址是随机分配的，所以程序运行的地址也是不确定的。</p>
<p>为了解决上面这些问题，引出了虚拟内存，此时，每个进程运行时都会得到4G的虚拟内存，每个进程都认为自己拥有4G空间，当然，这只是一厢情愿，实际上，虚拟内存可能只是对应一点点物理内存，实际用了多少内存，就会对应物理内存，也就是按需分配</p>
<p>进程得到的这4G虚拟内存是一个<strong>连续的地址空间，这也只是进程一厢情愿的想法，而实际上，它的物理地址是离散的，通常是被分隔成多个物理内存碎片，还有一部分存储在外部磁盘存储器上，在需要时还需使用请页、交换等技术。</strong><br>虚拟内存在wiki上的定义为：<strong>虚拟内存</strong>是计算机系统内存管理的一种技术。它使得应用程序认为它拥有连续可用的内存（一个连续完整的地址空间），而实际上，它通常是被分隔成多个物理内存碎片，还有部分暂时存储在外部磁盘存储器上，在需要时进行数据交换。与没有使用虚拟内存技术的系统相比，使用这种技术的系统使得大型程序的编写变得更容易，对真正的<a href="https://zh.wikipedia.org/wiki/%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98" target="_blank" rel="noopener">物理内存</a>（例如<a href="https://zh.wikipedia.org/wiki/%E9%9A%A8%E6%A9%9F%E5%AD%98%E5%8F%96%E8%A8%98%E6%86%B6%E9%AB%94" target="_blank" rel="noopener">RAM</a>）的使用也更有效率。</p>
<h2 id="进程访问一个地址的流程"><a href="#进程访问一个地址的流程" class="headerlink" title="进程访问一个地址的流程"></a><strong>进程访问一个地址的流程</strong></h2><ol>
<li>每次我要访问地址空间上的某一个地址，都需要把地址翻译为实际物理内存地址</li>
<li>所有进程共享这整一块物理内存，每个进程只把自己目前需要的虚拟地址空间映射到物理内存上</li>
<li>进程需要知道哪些地址空间上的数据在物理内存上，哪些不在（可能这部分存储在磁盘上），还有在物理内存上的哪里，这就需要通过页表来记录</li>
<li>页表的每一个表项分两部分，第一部分记录此页是否在物理内存上，第二部分记录物理内存页的地址（如果在的话）</li>
<li>当进程访问某个虚拟地址的时候，就会先去看页表，如果发现对应的数据不在物理内存上，就会发生缺页异常</li>
<li>缺页异常的处理过程，操作系统立即阻塞该进程，并将硬盘里对应的页换入内存，然后使该进程就绪，如果内存已经满了，没有空地方了，那就找一个页覆盖，至于具体覆盖的哪个页，就需要看操作系统的页面置换算法是怎么设计的了。</li>
</ol>
<p><strong>虚拟内存与物理内存的联系</strong><img src="https://uploader.shimo.im/f/lHaeiDc6TOo4pVmW.png!thumbnail" alt="图片"></p>
<p>图中，通过<strong>页表</strong>建立物理内存和虚拟内存之间的映射关系，页表的工作原理如下图：<br><img src="https://uploader.shimo.im/f/T37rxnJc4WEKYhMn.png!thumbnail" alt="图片"></p>
<p>我们的cpu想访问虚拟地址所在的虚拟页(VP3)，根据页表，找出页表中第三条的值.判断有效位。 如果有效位为1，DRMA缓存命中，根据物理页号，找到物理页当中的内容，返回。<br>若有效位为0，参数缺页异常，调用内核缺页异常处理程序。内核通过页面置换算法选择一个页面作为被覆盖的页面，将该页的内容刷新到磁盘空间当中。然后把VP3映射的磁盘文件缓存到该物理页上面。然后页表中第三条，有效位变成1，第二部分存储上了可以对应物理内存页的地址的内容。<br>缺页异常处理完毕后，返回中断前的指令，重新执行，此时缓存命中，执行1。<br>将找到的内容映射到告诉缓存当中，CPU从告诉缓存中获取该值，结束。</p>
<h2 id="虚拟内存的工作流程"><a href="#虚拟内存的工作流程" class="headerlink" title="虚拟内存的工作流程"></a><strong>虚拟内存的工作流程</strong></h2><p>当每个进程创建的时候，内核会为进程分配4G的虚拟内存，当进程还没有开始运行时，这只是一个内存布局。实际上并不立即就把虚拟内存对应位置的程序数据和代码（比如.text .data段）拷贝到物理内存中，只是建立好虚拟内存和磁盘文件之间的映射就好（叫做存储器映射）。这个时候数据和代码还是在磁盘上的。当运行到对应的程序时，进程去寻找页表，发现页表中地址没有存放在物理内存上，而是在磁盘上，于是发生缺页异常，于是将磁盘上的数据拷贝到物理内存中。</p>
<p>另外在进程运行过程中，要通过malloc来动态分配内存时，也只是分配了虚拟内存，即为这块虚拟内存对应的页表项做相应设置，当进程真正访问到此数据时，才引发缺页异常。</p>
<p>可以认为虚拟空间都被映射到了磁盘空间中（事实上也是按需要映射到磁盘空间上，通过mmap，mmap是用来建立虚拟空间和磁盘空间的映射关系的）</p>
<h2 id="利用虚拟内存机制的优点"><a href="#利用虚拟内存机制的优点" class="headerlink" title="利用虚拟内存机制的优点"></a>利用虚拟内存机制的优点</h2><p>既然每个进程的内存空间都是一致而且固定的（32位平台下都是4G），所以链接器在链接可执行文件时，可以设定内存地址，而不用去管这些数据最终实际内存地址，这交给内核来完成映射关系<br>当不同的进程使用同一段代码时，比如库文件的代码，在物理内存中可以只存储一份这样的代码，不同进程只要将自己的虚拟内存映射过去就好了，这样可以节省物理内存<br>在程序需要分配连续空间的时候，只需要在虚拟内存分配连续空间，而不需要物理内存时连续的，实际上，往往物理内存都是断断续续的内存碎片。这样就可以有效地利用我们的物理内存</p>
</div><div class="tags"><a href="/tags/Kernel/">Kernel</a></div><div class="post-share"></div><div class="post-nav"><a href="/阿里云￥9.5服务器开通管理及使用/" class="pre">阿里云￥9.5服务器开通管理及使用</a><a href="/开源大学/" class="next"></a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">Contents</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#什么是物理内存？"><span class="toc-text">什么是物理内存？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#那么什么又是虚拟内存呢？"><span class="toc-text">那么什么又是虚拟内存呢？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#进程访问一个地址的流程"><span class="toc-text">进程访问一个地址的流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#虚拟内存的工作流程"><span class="toc-text">虚拟内存的工作流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#利用虚拟内存机制的优点"><span class="toc-text">利用虚拟内存机制的优点</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/华为多次承认有研发手机系统，为什么不推广？/">华为多次承认有研发手机系统，为什么不推广？</a></li><li class="post-list-item"><a class="post-list-link" href="/羽毛球攻略/">羽毛球攻略</a></li><li class="post-list-item"><a class="post-list-link" href="/文件系统理论学习/">文件系统理论学习</a></li><li class="post-list-item"><a class="post-list-link" href="/空循环引起的问题/">空循环引起的问题</a></li><li class="post-list-item"><a class="post-list-link" href="/中断发展史/">中断发展史</a></li><li class="post-list-item"><a class="post-list-link" href="/Level DB和Couch DB的区别？/">Level DB和Couch DB的区别？</a></li><li class="post-list-item"><a class="post-list-link" href="/文件描述符/">文件描述符</a></li><li class="post-list-item"><a class="post-list-link" href="/C语言中fprintf和printf的区别？/">C语言中fprintf和printf的区别？</a></li><li class="post-list-item"><a class="post-list-link" href="/假期论文阅读汇总/">假期论文阅读汇总</a></li><li class="post-list-item"><a class="post-list-link" href="/JavaScript 全栈课程-答疑模块/">JavaScript 全栈课程-答疑模块</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> Tags</i></div><div class="tagcloud"><a href="/tags/安全/" style="font-size: 15px;">安全</a> <a href="/tags/BlurAdmin/" style="font-size: 15px;">BlurAdmin</a> <a href="/tags/C/" style="font-size: 15px;">C</a> <a href="/tags/FAQ/" style="font-size: 15px;">FAQ</a> <a href="/tags/教程/" style="font-size: 15px;">教程</a> <a href="/tags/Go/" style="font-size: 15px;">Go</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/IPFS/" style="font-size: 15px;">IPFS</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/数据库/" style="font-size: 15px;">数据库</a> <a href="/tags/Kernel/" style="font-size: 15px;">Kernel</a> <a href="/tags/MariaDB/" style="font-size: 15px;">MariaDB</a> <a href="/tags/实习/" style="font-size: 15px;">实习</a> <a href="/tags/PostgreSQL/" style="font-size: 15px;">PostgreSQL</a> <a href="/tags/Rust/" style="font-size: 15px;">Rust</a> <a href="/tags/模板/" style="font-size: 15px;">模板</a> <a href="/tags/博客/" style="font-size: 15px;">博客</a> <a href="/tags/分布式/" style="font-size: 15px;">分布式</a> <a href="/tags/安排/" style="font-size: 15px;">安排</a> <a href="/tags/论文/" style="font-size: 15px;">论文</a> <a href="/tags/师者/" style="font-size: 15px;">师者</a> <a href="/tags/未来/" style="font-size: 15px;">未来</a> <a href="/tags/运动/" style="font-size: 15px;">运动</a> <a href="/tags/操作系统/" style="font-size: 15px;">操作系统</a> <a href="/tags/云计算/" style="font-size: 15px;">云计算</a> <a href="/tags/Electron/" style="font-size: 15px;">Electron</a> <a href="/tags/区块链/" style="font-size: 15px;">区块链</a> <a href="/tags/系统优化/" style="font-size: 15px;">系统优化</a> <a href="/tags/红线/" style="font-size: 15px;">红线</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> Archive</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">May 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">April 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03/">March 2014</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> Blogroll</i></div><ul></ul><a href="http://www.dennishuang.cn/" title="从0开始的异世界" target="_blank">从0开始的异世界</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Site Haritası</a> |  <a href="/atom.xml">RSS</a> |  <a href="/about/">About</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">xiafei-xupt.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script></body></html>